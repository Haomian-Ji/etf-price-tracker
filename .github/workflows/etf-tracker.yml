# .github/workflows/etf-tracker.yml
name: ETF Price Tracker

on:
  # 每天定时执行（UTC时间21:30，对应北京时间05:30）
  schedule:
    - cron: '30 21 * * 1-5'  # 周一至周五，UTC 21:30（北京时间05:30）
  
  # 支持手动触发
  workflow_dispatch:
    inputs:
      debug:
        description: 'Debug mode'
        required: false
        default: false
        type: boolean

  # 代码推送时测试（可选）
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - '.github/workflows/**'
      - 'requirements.txt'

jobs:
  fetch-etf-prices:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt # 这里应该已包含修复后的版本

    - name: Run ETF tracker
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        # 如果未设置这些可选密钥，其值将为空白字符串，但程序应能处理
        ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}
        FINNHUB_KEY: ${{ secrets.FINNHUB_KEY }}
      run: |
        python src/main.py

    - name: Upload logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: etf-tracker-logs
        path: |
          *.log
        retention-days: 7